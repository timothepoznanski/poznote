name: Publish Docker image

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        run: echo "VERSION=$(cat src/version.txt)" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/poznote:${{ env.VERSION }}
            ghcr.io/${{ github.repository_owner }}/poznote:latest

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Increment version
        run: |
          current=$(cat src/version.txt)
          IFS='.' read -r major minor patch <<< "$current"
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          echo "$new_version" > src/version.txt

      - name: Commit and push version
        run: |
          git add src/version.txt
          new_version=$(cat src/version.txt)
          git commit -m "Bump version to $new_version [skip ci]" || echo "No changes to commit"
          git push || echo "No changes to push"