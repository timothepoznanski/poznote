services:  
  webserver:       
    build:
      context: .
      dockerfile: Dockerfile
    restart: always      
    env_file: .env
    environment:
      SQLITE_DATABASE: /var/www/html/data/database/poznote.db
    ports:
      - "${HTTP_WEB_PORT}:80"
    volumes:
      - "./src:/var/www/html"
      - "./data:/var/www/html/data"

  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    image: poznote-mcp:dev
    container_name: poznote-mcp-dev
    restart: unless-stopped
    environment:
      POZNOTE_API_URL: http://webserver:80/api/v1
      POZNOTE_USERNAME: ${POZNOTE_MCP_USERNAME:-admin}
      POZNOTE_PASSWORD: ${POZNOTE_PASSWORD:-admin}
      POZNOTE_USER_ID: ${POZNOTE_MCP_USER_ID:-1}
      POZNOTE_DEFAULT_WORKSPACE: ${POZNOTE_MCP_WORKSPACE:-Poznote}
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "8045"
      POZNOTE_DEBUG: ${POZNOTE_MCP_DEBUG:-true}
    ports:
      - "127.0.0.1:${POZNOTE_MCP_PORT:-8046}:8045"
    depends_on:
      - webserver
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --quiet --tries=1 --timeout=5 -O /dev/null http://127.0.0.1:8045/ || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
