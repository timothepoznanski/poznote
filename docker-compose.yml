# Poznote Docker Compose Configuration
# 
# IMPORTANT: When updating Poznote, always update these files:
# 
# 1. docker-compose.yml:
#    curl -o docker-compose.yml https://raw.githubusercontent.com/timothepoznanski/poznote/main/docker-compose.yml
#
# 2. .env.template (compare with your .env):
#    curl -o .env.template https://raw.githubusercontent.com/timothepoznanski/poznote/main/.env.template
#    sdiff .env .env.template  # Add any new variables to your .env
#
# The :4 tag automatically gets new 4.x.x versions, but new environment variables
# or configuration options require updating these files manually.

services:
  webserver:
    image: ghcr.io/timothepoznanski/poznote:4
    restart: always
    env_file: .env
    environment:
      SQLITE_DATABASE: /var/www/html/data/database/poznote.db
    ports:
      - "${HTTP_WEB_PORT}:80"
    volumes:
      - "./data:/var/www/html/data"

  mcp-server:
    image: ghcr.io/timothepoznanski/poznote-mcp:4
    container_name: poznote-mcp
    restart: unless-stopped
    environment:
      POZNOTE_API_URL: http://webserver:80/api/v1
      POZNOTE_USERNAME: ${POZNOTE_MCP_USERNAME:-admin}
      POZNOTE_PASSWORD: ${POZNOTE_PASSWORD:-admin}
      POZNOTE_USER_ID: ${POZNOTE_MCP_USER_ID:-1}
      POZNOTE_DEFAULT_WORKSPACE: ${POZNOTE_MCP_WORKSPACE:-Poznote}
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "8045"
      POZNOTE_DEBUG: ${POZNOTE_MCP_DEBUG:-false}
    ports:
      - "127.0.0.1:${POZNOTE_MCP_PORT:-8045}:8045"
    depends_on:
      - webserver
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --quiet --tries=1 --timeout=5 -O /dev/null http://127.0.0.1:8045/ || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
