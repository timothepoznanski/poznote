services:
  webserver:
    image: ghcr.io/timothepoznanski/poznote:latest
    restart: always
    environment:
      SQLITE_DATABASE: /var/www/html/data/database/poznote.db
      POZNOTE_PASSWORD: ${POZNOTE_PASSWORD:-admin}
      POZNOTE_PASSWORD_USER: ${POZNOTE_PASSWORD_USER:-user}
      HTTP_WEB_PORT: ${HTTP_WEB_PORT}
      POZNOTE_OIDC_ENABLED: ${POZNOTE_OIDC_ENABLED:-false}
      POZNOTE_OIDC_PROVIDER_NAME: ${POZNOTE_OIDC_PROVIDER_NAME:-SSO}
      POZNOTE_OIDC_ISSUER: ${POZNOTE_OIDC_ISSUER:-}
      POZNOTE_OIDC_DISCOVERY_URL: ${POZNOTE_OIDC_DISCOVERY_URL:-}
      POZNOTE_OIDC_CLIENT_ID: ${POZNOTE_OIDC_CLIENT_ID:-}
      POZNOTE_OIDC_CLIENT_SECRET: ${POZNOTE_OIDC_CLIENT_SECRET:-}
      POZNOTE_OIDC_ALLOWED_USERS: ${POZNOTE_OIDC_ALLOWED_USERS:-}
      POZNOTE_OIDC_SCOPES: ${POZNOTE_OIDC_SCOPES:-openid profile email}
      POZNOTE_OIDC_REDIRECT_URI: ${POZNOTE_OIDC_REDIRECT_URI:-}
      POZNOTE_OIDC_END_SESSION_ENDPOINT: ${POZNOTE_OIDC_END_SESSION_ENDPOINT:-}
      POZNOTE_OIDC_POST_LOGOUT_REDIRECT_URI: ${POZNOTE_OIDC_POST_LOGOUT_REDIRECT_URI:-}
      POZNOTE_OIDC_DISABLE_NORMAL_LOGIN: ${POZNOTE_OIDC_DISABLE_NORMAL_LOGIN:-false}
      POZNOTE_OIDC_DISABLE_BASIC_AUTH: ${POZNOTE_OIDC_DISABLE_BASIC_AUTH:-false}
      POZNOTE_DISABLE_SETTINGS_ACCESS: ${POZNOTE_DISABLE_SETTINGS_ACCESS:-false}
      POZNOTE_SETTINGS_PASSWORD: ${POZNOTE_SETTINGS_PASSWORD:-}
      POZNOTE_IMPORT_MAX_INDIVIDUAL_FILES: ${POZNOTE_IMPORT_MAX_INDIVIDUAL_FILES:-50}
      POZNOTE_IMPORT_MAX_ZIP_FILES: ${POZNOTE_IMPORT_MAX_ZIP_FILES:-300}
      POZNOTE_GITHUB_SYNC_ENABLED: ${POZNOTE_GITHUB_SYNC_ENABLED:-false}
      POZNOTE_GITHUB_TOKEN: ${POZNOTE_GITHUB_TOKEN:-}
      POZNOTE_GITHUB_REPO: ${POZNOTE_GITHUB_REPO:-}
      POZNOTE_GITHUB_BRANCH: ${POZNOTE_GITHUB_BRANCH:-main}
      POZNOTE_GITHUB_AUTHOR_NAME: ${POZNOTE_GITHUB_AUTHOR_NAME:-Poznote}
      POZNOTE_GITHUB_AUTHOR_EMAIL: ${POZNOTE_GITHUB_AUTHOR_EMAIL:-poznote@localhost}
    ports:
      - "${HTTP_WEB_PORT}:80"
    volumes:
      - "./data:/var/www/html/data"

  mcp-server:
    image: ghcr.io/timothepoznanski/poznote-mcp:latest
    container_name: poznote-mcp
    restart: unless-stopped
    environment:
      POZNOTE_API_URL: http://webserver:80/api/v1
      POZNOTE_USERNAME: ${POZNOTE_MCP_USERNAME:-admin}
      POZNOTE_PASSWORD: ${POZNOTE_PASSWORD:-admin}
      POZNOTE_USER_ID: ${POZNOTE_MCP_USER_ID:-1}
      POZNOTE_DEFAULT_WORKSPACE: ${POZNOTE_MCP_WORKSPACE:-Poznote}
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "8045"
      POZNOTE_DEBUG: ${POZNOTE_MCP_DEBUG:-false}
    ports:
      - "${POZNOTE_MCP_PORT:-8045}:8045"
    depends_on:
      - webserver
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --quiet --tries=1 --timeout=5 -O /dev/null http://127.0.0.1:8045/ || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
