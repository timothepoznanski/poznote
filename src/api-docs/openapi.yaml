openapi: 3.0.3
info:
  title: Poznote API
  description: |
    REST API for Poznote - Note-taking application with workspaces, folders, tags and attachments support.
    
    **Authentication:** All endpoints support both HTTP Basic Authentication and Session Authentication.
    - Use HTTP Basic Auth (`-u username:password`) for scripts and automation
    - Use Session Auth for browser-based access (Swagger UI)
    
    [View complete curl examples in the README](https://github.com/timothepoznanski/poznote#api-documentation)
  version: 1.0.0

tags:
  - name: Notes Management
  - name: Trash Management
  - name: Folders Management
  - name: Workspaces Management
  - name: Tags Management
  - name: Attachments Management
  - name: Favorites Management
  - name: Backup Management
  - name: System Information

security:
  - BasicAuth: []
  - SessionAuth: []

components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic
    SessionAuth:
      type: apiKey
      in: cookie
      name: PHPSESSID

  schemas:
    Note:
      type: object
      properties:
        id:
          type: integer
        heading:
          type: string
        subheading:
          type: string
        entrycontent:
          type: string
        tags:
          type: string
        folder:
          type: string
        workspace:
          type: string
        favorite:
          type: integer
          enum: [0, 1]
        trash:
          type: integer
          enum: [0, 1]
        type:
          type: string
          enum: [note, markdown, tasklist]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

paths:
  /api_list_notes.php:
    get:
      tags:
        - Notes Management
      summary: List notes
      description: Get list of notes with optional filters
      parameters:
        - name: workspace
          in: query
          required: false
          description: "Filter by workspace name (optional)"
          schema:
            type: string
        - name: folder
          in: query
          required: false
          description: "Filter by folder name (optional)"
          schema:
            type: string
        - name: search
          in: query
          required: false
          description: "Text search in note content (optional)"
          schema:
            type: string
        - name: tag
          in: query
          required: false
          description: "Filter by tag (optional)"
          schema:
            type: string
        - name: favorite
          in: query
          required: false
          description: "Filter favorites only - 1=yes, 0=no (optional)"
          schema:
            type: integer
            enum: [0, 1]
        - name: get_folders
          in: query
          required: false
          description: "Return folders list instead of notes (optional)"
          schema:
            type: boolean
      responses:
        '200':
          description: Success

  /api_note_content.php:
    get:
      tags:
        - Notes Management
      summary: Get note content
      description: |
        Returns the raw stored content for a note.

        Provide either:
        - `id` (recommended). You may also provide `workspace` to scope the lookup.
        - or `reference` + `workspace` to resolve by title within a workspace.
          `reference` can be a numeric id or a (partial) title.
      parameters:
        - name: id
          in: query
          required: false
          description: "Note ID (recommended)"
          schema:
            type: integer
            example: 123
        - name: reference
          in: query
          required: false
          description: "Note reference (numeric id or partial title). Requires workspace when used."
          schema:
            type: string
            example: "My Note"
        - name: workspace
          in: query
          required: false
          description: "Workspace name (optional with id, required with reference)"
          schema:
            type: string
            example: "Poznote"
      responses:
        '200':
          description: Note content returned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  id:
                    type: integer
                    example: 123
                  heading:
                    type: string
                    example: "My Note"
                  workspace:
                    type: string
                    nullable: true
                    example: "Poznote"
                  type:
                    type: string
                    example: "markdown"
                  content:
                    type: string
                    description: "Raw stored note content (Markdown/HTML/JSON depending on type)"
        '400':
          description: Bad request (missing/invalid parameters)
        '404':
          description: Note not found
        '500':
          description: Server error

  /api_create_note.php:
    post:
      tags:
        - Notes Management
      summary: Create note
      description: Create a new note with content
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - heading
              properties:
                heading:
                  type: string
                  description: "Note title (required)"
                  example: "My New Note"
                subheading:
                  type: string
                  description: "Note subtitle (optional)"
                  example: "Important information"
                entrycontent:
                  type: string
                  description: "Text content (optional)"
                  example: "This is the content of my note"
                entry:
                  type: string
                  description: "HTML content (optional)"
                  example: "<p>This is <strong>HTML</strong> content</p>"
                tags:
                  type: string
                  description: "Comma-separated tags (optional)"
                  example: "work,important,todo"
                folder_name:
                  type: string
                  description: "Folder name (optional, default: Default)"
                  example: "Work"
                workspace:
                  type: string
                  description: "Workspace name (optional, default: Poznote)"
                  example: "Personal"
                type:
                  type: string
                  enum: [note, markdown, tasklist]
                  description: "Note type (optional, default: note)"
                  example: "note"
                location:
                  type: string
                  description: "Geographic location (optional)"
                  example: "Paris"
      responses:
        '200':
          description: Note created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Note created successfully"
                  id:
                    type: integer
                    description: ID of created note
                    example: 123

  /api_apply_tags.php:
    post:
      tags:
        - Tags Management
      summary: Apply Tags
      description: Add or update tags for a specific note (replaces existing tags). Tags can be provided as a comma-separated string or as an array.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note_id
                - tags
              properties:
                note_id:
                  type: integer
                  description: "Note ID (required)"
                  example: 123
                tags:
                  oneOf:
                    - type: string
                      description: "Comma-separated tags"
                      example: "work,urgent,meeting"
                    - type: array
                      description: "Array of tags"
                      items:
                        type: string
                      example: ["work", "urgent", "meeting"]
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
      responses:
        '200':
          description: Tags updated successfully

  /api_delete_note.php:
    delete:
      tags:
        - Notes Management
      summary: Delete note
      description: Move note to trash (soft delete)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note_id
              properties:
                note_id:
                  type: integer
                  description: "Note ID to delete (required)"
                  example: 123
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
                permanent:
                  type: boolean
                  description: "If true, permanently delete the note (optional, default: false)"
                  example: false
      responses:
        '200':
          description: Note moved to trash or permanently deleted successfully

  /api_list_trash.php:
    get:
      tags:
        - Trash Management
      summary: List trash notes
      description: Get list of notes in trash with optional filters
      parameters:
        - name: workspace
          in: query
          required: false
          description: "Filter by workspace name (optional)"
          schema:
            type: string
            example: "Personal"
        - name: search
          in: query
          required: false
          description: "Search in heading, subheading, and tags (optional)"
          schema:
            type: string
            example: "meeting"
      responses:
        '200':
          description: List of trash notes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  total:
                    type: integer
                    description: Total number of notes in trash
                    example: 5
                  count:
                    type: integer
                    description: Number of notes returned (after filters)
                    example: 5
                  notes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Note'
                  filters:
                    type: object
                    properties:
                      workspace:
                        type: string
                        nullable: true
                      search:
                        type: string
                        nullable: true

  /api_restore_note.php:
    post:
      tags:
        - Trash Management
      summary: Restore note from trash
      description: Restore a note from trash (set trash = 0)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: integer
                  description: "Note ID to restore (required)"
                  example: 123
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
      responses:
        '200':
          description: Note restored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Note restored successfully"
                  note_id:
                    type: integer
                    example: 123
                  note_heading:
                    type: string
                    example: "My restored note"
        '400':
          description: Bad request (note not in trash or ID missing)
        '404':
          description: Note not found

  /api_share_note.php:
    post:
      tags:
        - Notes Management
      summary: Share note
      description: Manage public sharing for a note (create, get, revoke, or renew share link)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note_id
              properties:
                note_id:
                  type: integer
                  description: "Note ID (required)"
                  example: 123
                action:
                  type: string
                  enum: [create, get, revoke, renew]
                  description: "Action to perform: 'create' (generate new link), 'get' (retrieve existing), 'revoke' (disable sharing), 'renew' (generate new token)"
                  example: "create"
                  default: "create"
      responses:
        '200':
          description: Sharing action completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  url:
                    type: string
                    description: Public share URL (for create/get/renew actions)
                  shared:
                    type: boolean
                    description: Current sharing status
                  revoked:
                    type: boolean
                    description: True if revoke action was successful

  /api_workspaces.php:
    get:
      tags:
        - Workspaces Management
      summary: List workspaces
      description: Get all available workspaces
      parameters:
        - name: action
          in: query
          required: false
          description: "Action to perform (default: list)"
          schema:
            type: string
            enum: [list]
            default: "list"
      responses:
        '200':
          description: List of workspaces returned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  workspaces:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        created:
                          type: string
                          format: date-time
    post:
      tags:
        - Workspaces Management
      summary: Manage workspaces
      description: Create, delete, or rename workspaces
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  title: Create workspace
                  required:
                    - action
                    - name
                  properties:
                    action:
                      type: string
                      enum: [create]
                      example: "create"
                    name:
                      type: string
                      description: "Workspace name (letters, numbers, dash, underscore only)"
                      example: "MyProject"
                - type: object
                  title: Delete workspace
                  required:
                    - action
                    - name
                  properties:
                    action:
                      type: string
                      enum: [delete]
                      example: "delete"
                    name:
                      type: string
                      description: "Workspace name to delete (cannot delete 'Poznote')"
                      example: "OldWorkspace"
                - type: object
                  title: Rename workspace
                  required:
                    - action
                    - old_name
                    - new_name
                  properties:
                    action:
                      type: string
                      enum: [rename]
                      example: "rename"
                    old_name:
                      type: string
                      description: "Current workspace name"
                      example: "OldName"
                    new_name:
                      type: string
                      description: "New workspace name"
                      example: "NewName"
      responses:
        '200':
          description: Workspace operation completed successfully

  /api_list_tags.php:
    get:
      tags:
        - Tags Management
      summary: List all tags
      description: Get all tags with usage count
      parameters:
        - name: workspace
          in: query
          required: false
          description: "Filter by workspace (optional)"
          schema:
            type: string
            example: "Poznote"
      responses:
        '200':
          description: List of tags with counts returned successfully

  /api_favorites.php:
    post:
      tags:
        - Favorites Management
      summary: Toggle favorite
      description: Toggle favorite status for a note (automatically adds or removes from favorites)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - note_id
              properties:
                action:
                  type: string
                  enum: [toggle_favorite]
                  description: "Action to perform (required)"
                  example: "toggle_favorite"
                note_id:
                  type: integer
                  description: "Note ID (required)"
                  example: 123
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
      responses:
        '200':
          description: Favorite status toggled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  is_favorite:
                    type: integer
                    enum: [0, 1]
                    description: "New favorite status: 1=favorite, 0=not favorite"

  /api_attachments.php:
    get:
      tags:
        - Attachments Management
      summary: List attachments
      description: Get all attachments for a specific note
      parameters:
        - name: action
          in: query
          required: true
          description: "Action to perform (required)"
          schema:
            type: string
            enum: [list]
            example: "list"
        - name: note_id
          in: query
          required: true
          description: "Note ID (required)"
          schema:
            type: integer
            example: 123
        - name: workspace
          in: query
          required: false
          description: "Workspace name (optional)"
          schema:
            type: string
            example: "Personal"
      responses:
        '200':
          description: List of attachments returned successfully
    post:
      tags:
        - Attachments Management
      summary: Upload attachment
      description: Upload a file and attach it to a note
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - action
                - note_id
                - file
              properties:
                action:
                  type: string
                  enum: [upload]
                  description: "Action to perform (required)"
                  example: "upload"
                note_id:
                  type: integer
                  description: "Note ID (required)"
                  example: 123
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
                file:
                  type: string
                  format: binary
                  description: "File to upload (required)"
      responses:
        '200':
          description: File uploaded successfully

  /api_create_folder.php:
    post:
      tags:
        - Folders Management
      summary: Create folder
      description: Create a new folder in a workspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - folder_name
              properties:
                folder_name:
                  type: string
                  description: "Folder name (required)"
                  example: "Work Projects"
                workspace:
                  type: string
                  description: "Workspace name (optional, default: Poznote)"
                  example: "Personal"
      responses:
        '200':
          description: Folder created successfully

  /api_delete_folder.php:
    delete:
      tags:
        - Folders Management
      summary: Delete folder
      description: Delete a folder and move all its contents to no folder (uncategorized)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - folder_name
              properties:
                folder_name:
                  type: string
                  description: "Folder name to delete (required)"
                  example: "Old Projects"
                folder_id:
                  type: integer
                  description: "Folder ID (optional, alternative to folder_name)"
                  example: 5
                workspace:
                  type: string
                  description: "Workspace name (optional)"
                  example: "Personal"
      responses:
        '200':
          description: Folder deleted successfully
        '400':
          description: Invalid request
        '404':
          description: Folder not found

  /api_backup.php:
    post:
      tags:
        - Backup Management
      summary: Create complete backup
      description: |
        Creates a complete backup ZIP file containing:
        - Database SQL dump
        - All HTML note entries
        - All attachments with metadata
        - Index.html file for offline browsing
        
        **Authentication:** Supports both HTTP Basic Auth and Session Auth.
        
        The backup file is saved in the `data/backups/` directory and can be downloaded using the returned path.
      security:
        - BasicAuth: []
        - SessionAuth: []
      responses:
        '200':
          description: Backup created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Backup created successfully"
                  backup_file:
                    type: string
                    description: Filename of the created backup
                    example: "poznote_backup_2025-10-24_14-30-15.zip"
                  backup_path:
                    type: string
                    description: Relative path to download the backup
                    example: "../data/backups/poznote_backup_2025-10-24_14-30-15.zip"
                  backup_size:
                    type: integer
                    description: Size in bytes
                    example: 1048576
                  backup_size_mb:
                    type: number
                    format: float
                    description: Size in megabytes
                    example: 1.0
                  created_at:
                    type: string
                    format: date-time
                    description: ISO 8601 timestamp of creation
                    example: "2025-10-24T14:30:15+00:00"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Authentication required"
        '500':
          description: Server error during backup creation
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to create backup file"

  /api_list_backups.php:
    get:
      tags:
        - Backup Management
      summary: List available backups
      description: |
        Returns a list of all available backup files in the backups directory, sorted by creation date (newest first).
        
        **Authentication:** Supports both HTTP Basic Auth and Session Auth.
      security:
        - BasicAuth: []
        - SessionAuth: []
      responses:
        '200':
          description: List of backups returned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  backups:
                    type: array
                    items:
                      type: object
                      properties:
                        filename:
                          type: string
                          example: "poznote_backup_2025-10-24_14-30-15.zip"
                        path:
                          type: string
                          example: "../data/backups/poznote_backup_2025-10-24_14-30-15.zip"
                        download_url:
                          type: string
                          example: "api_download_backup.php?filename=poznote_backup_2025-10-24_14-30-15.zip"
                        size:
                          type: integer
                          example: 1048576
                        size_mb:
                          type: number
                          format: float
                          example: 1.0
                        created_at:
                          type: string
                          format: date-time
                          example: "2025-10-24T14:30:15+00:00"
                  total:
                    type: integer
                    description: Total number of backups
                    example: 5
        '401':
          description: Authentication required

  /api_download_backup.php:
    get:
      tags:
        - Backup Management
      summary: Download a backup file
      description: |
        Downloads a specific backup file from the backups directory.
        The file will be sent as a ZIP download.
        
        **Authentication:** Supports both HTTP Basic Auth and Session Auth.
      security:
        - BasicAuth: []
        - SessionAuth: []
      parameters:
        - name: filename
          in: query
          required: true
          description: "Name of the backup file to download (must match pattern poznote_backup_YYYY-MM-DD_HH-MM-SS.zip)"
          schema:
            type: string
            example: "poznote_backup_2025-10-24_14-30-15.zip"
      responses:
        '200':
          description: Backup file download
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '400':
          description: Bad request (missing filename or invalid format)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid backup filename format"
        '401':
          description: Authentication required
        '404':
          description: Backup file not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Backup file not found"

  /api_version.php:
    get:
      tags:
        - System Information
      summary: Check version
      description: Get current version and check if updates are available
      responses:
        '200':
          description: Version information
          content:
            application/json:
              schema:
                type: object
                properties:
                  current_version:
                    type: string
                    description: Current installed version
                    example: "1.0.30"
                  latest_version:
                    type: string
                    description: Latest available version from GitHub
                    example: "1.0.31"
                  is_up_to_date:
                    type: boolean
                    description: Whether the current version is up to date
                    example: false
                  has_update:
                    type: boolean
                    description: Whether an update is available
                    example: true
                  update_available:
                    type: boolean
                    description: Whether an update is available (alias)
                    example: true
                  error:
                    type: string
                    nullable: true
                    description: Error message if version check failed
                    example: null
        '401':
          description: Authentication required
