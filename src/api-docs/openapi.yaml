openapi: 3.0.3
info:
  title: Poznote REST API v1
  description: |
    RESTful API for Poznote - Note-taking application with workspaces, folders, tags and attachments support.
    
    **Base URL:** `/api/v1`
    
    ## Authentication
    
    All endpoints support both HTTP Basic Authentication and Session Authentication.
    - Use HTTP Basic Auth (`-u username:password`) for scripts and automation
    - Use Session Auth for browser-based access (Swagger UI)
    
    ### Multi-User Mode
    
    Poznote supports multiple user profiles, each with their own isolated data (notes, folders, attachments, etc.).
    
    For endpoints that access **user data** (notes, folders, workspaces, etc.), you must include the `X-User-ID` header to specify which user's data to access:
    
    ```bash
    curl -u admin:password -H "X-User-ID: 1" https://poznote.example.com/api/v1/notes
    ```
    
    **Admin endpoints** (`/admin/*`) and **public endpoints** (`/users/profiles`) do **not** require the `X-User-ID` header.
    
    Use `GET /api/v1/users/profiles` to list available user profiles and their IDs.

    **OIDC / SSO (optional):** Poznote can be configured to authenticate users via OpenID Connect for interactive login.
    - Start the flow: `GET /oidc_login.php`
    - Callback: `GET /oidc_callback.php`
    
    [View complete documentation on GitHub](https://github.com/timothepoznanski/poznote)
  version: 2.0.0

servers:
  - url: /api/v1
    description: REST API v1

tags:
  - name: Notes
    description: Notes CRUD operations
  - name: Folders
    description: Folders management
  - name: Trash
    description: Trash management
  - name: Workspaces
    description: Workspaces management
  - name: Tags
    description: Tags listing
  - name: Attachments
    description: File attachments
  - name: Share
    description: Note and folder sharing
  - name: Settings
    description: Application settings
  - name: Backups
    description: Backup and restore
  - name: System
    description: System information and utilities
  - name: Users
    description: User profiles management
  - name: Export
    description: Export operations (legacy endpoints)

security:
  - BasicAuth: []
  - SessionAuth: []

components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic
      description: HTTP Basic Auth with global username/password. Include X-User-ID header for data endpoints.
    SessionAuth:
      type: apiKey
      in: cookie
      name: POZNOTE_SESSION_8040
  
  parameters:
    UserIdHeader:
      name: X-User-ID
      in: header
      required: true
      schema:
        type: integer
      description: User profile ID to access. Required for all data endpoints (notes, folders, etc.). Use GET /users/profiles to list available profiles.

  schemas:
    Note:
      type: object
      properties:
        id:
          type: integer
          example: 123
        heading:
          type: string
          example: "My Note Title"
        entrycontent:
          type: string
          example: "# Hello World\n\nThis is my note content."
        tags:
          type: string
          example: "work,important"
        folder:
          type: string
          nullable: true
          example: "Projects"
        workspace:
          type: string
          example: "Personal"
        favorite:
          type: integer
          enum: [0, 1]
        trash:
          type: integer
          enum: [0, 1]
        type:
          type: string
          enum: [note, markdown, tasklist, excalidraw]
        created:
          type: string
          format: date-time
        updated:
          type: string
          format: date-time

    Folder:
      type: object
      properties:
        id:
          type: integer
          example: 12
        name:
          type: string
          example: "Projects"
        workspace:
          type: string
          example: "Personal"
        parent_id:
          type: integer
          nullable: true
        icon:
          type: string
          nullable: true
          example: "fa-folder"

    Workspace:
      type: object
      properties:
        name:
          type: string
          example: "Personal"
        note_count:
          type: integer
          example: 42

    Attachment:
      type: object
      properties:
        id:
          type: integer
          example: 1
        note_id:
          type: integer
          example: 123
        filename:
          type: string
          example: "document.pdf"
        original_filename:
          type: string
          example: "My Document.pdf"
        mime_type:
          type: string
          example: "application/pdf"
        size:
          type: integer
          example: 102400
        uploaded_at:
          type: string
          format: date-time

    Backup:
      type: object
      properties:
        filename:
          type: string
          example: "poznote_backup_2025-01-05_12-00-00.zip"
        size:
          type: integer
          example: 1975805
        size_mb:
          type: number
          example: 1.88
        created_at:
          type: string
          format: date-time
        download_url:
          type: string
          example: "/api/v1/backups/poznote_backup_2025-01-05_12-00-00.zip"

    ShareInfo:
      type: object
      properties:
        is_shared:
          type: boolean
        token:
          type: string
          nullable: true
        url:
          type: string
          nullable: true
        theme:
          type: string
          enum: [light, dark, auto]
        indexable:
          type: boolean
        has_password:
          type: boolean
        expires:
          type: string
          format: date-time
          nullable: true

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Error message"

    Success:
      type: object
      properties:
        success:
          type: boolean
          example: true

paths:
  # ==================
  # Notes Endpoints
  # ==================
  /notes:
    get:
      tags: [Notes]
      summary: List notes
      description: Get list of notes with optional filters
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
          description: Filter by workspace name
        - name: folder
          in: query
          schema:
            type: string
          description: Filter by folder name
        - name: search
          in: query
          schema:
            type: string
          description: Search in note content
        - name: tag
          in: query
          schema:
            type: string
          description: Filter by tag
        - name: favorite
          in: query
          schema:
            type: integer
            enum: [0, 1]
          description: Filter favorites only
        - name: type
          in: query
          schema:
            type: string
            enum: [note, markdown, tasklist, excalidraw]
          description: Filter by note type
      responses:
        '200':
          description: List of notes
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  notes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Note'
    post:
      tags: [Notes]
      summary: Create a new note
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                heading:
                  type: string
                  example: "New Note"
                content:
                  type: string
                  example: "Note content here"
                workspace:
                  type: string
                  example: "Personal"
                folder_id:
                  type: integer
                  nullable: true
                  description: ID of the folder (optional)
                  example: 12
                type:
                  type: string
                  enum: [note, markdown, tasklist]
                  default: note
                tags:
                  type: string
                  example: "tag1,tag2"
      responses:
        '201':
          description: Note created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  id:
                    type: integer
                  message:
                    type: string

  /notes/resolve:
    get:
      tags: [Notes]
      summary: Resolve a note reference
      description: Find a note by title or ID within a workspace
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: reference
          in: query
          required: true
          schema:
            type: string
          description: Note title or ID
        - name: workspace
          in: query
          required: true
          schema:
            type: string
          description: Workspace to search in
      responses:
        '200':
          description: Note found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  note:
                    $ref: '#/components/schemas/Note'

  /notes/with-attachments:
    get:
      tags: [Notes]
      summary: List notes with attachments
      parameters:
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of notes that have attachments

  /notes/{id}:
    get:
      tags: [Notes]
      summary: Get a specific note
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Note details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  note:
                    $ref: '#/components/schemas/Note'
        '404':
          description: Note not found
    patch:
      tags: [Notes]
      summary: Update a note
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                heading:
                  type: string
                content:
                  type: string
                tags:
                  type: string
                folder_id:
                  type: integer
                  nullable: true
                  description: ID of the folder (optional)
      responses:
        '200':
          description: Note updated
    delete:
      tags: [Notes]
      summary: Delete a note (move to trash)
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: permanent
          in: query
          schema:
            type: boolean
            default: false
          description: Permanently delete instead of moving to trash
      responses:
        '200':
          description: Note deleted

  /notes/{id}/restore:
    post:
      tags: [Notes]
      summary: Restore a note from trash
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Note restored

  /notes/{id}/tags:
    put:
      tags: [Notes]
      summary: Update note tags
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                tags:
                  type: string
                  example: "tag1,tag2,tag3"
      responses:
        '200':
          description: Tags updated

  /notes/{id}/favorite:
    post:
      tags: [Notes]
      summary: Toggle favorite status
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Favorite status toggled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  favorite:
                    type: integer
                    enum: [0, 1]

  /notes/{id}/duplicate:
    post:
      tags: [Notes]
      summary: Duplicate a note
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '201':
          description: Note duplicated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  new_note_id:
                    type: integer

  /notes/{id}/folder:
    post:
      tags: [Notes]
      summary: Move note to a folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                folder_id:
                  type: integer
                folder_name:
                  type: string
      responses:
        '200':
          description: Note moved

  /notes/{id}/remove-folder:
    post:
      tags: [Notes]
      summary: Remove note from folder (move to root)
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Note moved to root

  /notes/{id}/beacon:
    post:
      tags: [Notes]
      summary: Emergency save via sendBeacon
      description: Used for saving note content when page is closing
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                content:
                  type: string
                heading:
                  type: string
      responses:
        '200':
          description: Note saved

  # ==================
  # Share Endpoints
  # ==================
  /notes/{id}/share:
    get:
      tags: [Share]
      summary: Get share status
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Share status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  share:
                    $ref: '#/components/schemas/ShareInfo'
    post:
      tags: [Share]
      summary: Create or renew share link
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                theme:
                  type: string
                  enum: [light, dark, auto]
                indexable:
                  type: boolean
                password:
                  type: string
                expires_days:
                  type: integer
      responses:
        '200':
          description: Share link created
    patch:
      tags: [Share]
      summary: Update share settings
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                theme:
                  type: string
                indexable:
                  type: boolean
                password:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Share settings updated
    delete:
      tags: [Share]
      summary: Revoke share link
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Share link revoked

  /shared:
    get:
      tags: [Share]
      summary: List all shared notes
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of shared notes

  /folders/{folderId}/share:
    get:
      tags: [Share]
      summary: Get folder share status
      parameters:
        - name: folderId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Folder share status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  public:
                    type: boolean
                  url:
                    type: string
                  indexable:
                    type: integer
                  hasPassword:
                    type: boolean
    post:
      tags: [Share]
      summary: Create or renew folder share link
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: folderId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                custom_token:
                  type: string
                theme:
                  type: string
                  enum: [light, dark]
                indexable:
                  type: integer
                password:
                  type: string
      responses:
        '201':
          description: Folder share link created
    patch:
      tags: [Share]
      summary: Update folder share settings
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: folderId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                indexable:
                  type: integer
                password:
                  type: string
                custom_token:
                  type: string
      responses:
        '200':
          description: Folder share settings updated
    delete:
      tags: [Share]
      summary: Revoke folder share link
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: folderId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Folder share link revoked

  # ==================
  # Attachments Endpoints
  # ==================
  /notes/{noteId}/attachments:
    get:
      tags: [Attachments]
      summary: List attachments for a note
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: noteId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List of attachments
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  attachments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Attachment'
    post:
      tags: [Attachments]
      summary: Upload an attachment
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: noteId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Attachment uploaded

  /notes/{noteId}/attachments/{attachmentId}:
    get:
      tags: [Attachments]
      summary: Download an attachment
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: noteId
          in: path
          required: true
          schema:
            type: integer
        - name: attachmentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: File download
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
    delete:
      tags: [Attachments]
      summary: Delete an attachment
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: noteId
          in: path
          required: true
          schema:
            type: integer
        - name: attachmentId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Attachment deleted

  # ==================
  # Folders Endpoints
  # ==================
  /folders:
    get:
      tags: [Folders]
      summary: List all folders
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
        - name: tree
          in: query
          schema:
            type: boolean
          description: Return as nested tree structure
      responses:
        '200':
          description: List of folders
    post:
      tags: [Folders]
      summary: Create a new folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, workspace]
              properties:
                name:
                  type: string
                workspace:
                  type: string
                parent_id:
                  type: integer
                  nullable: true
      responses:
        '201':
          description: Folder created

  /folders/counts:
    get:
      tags: [Folders]
      summary: Get note counts for all folders
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Folder counts

  /folders/suggested:
    get:
      tags: [Folders]
      summary: Get suggested folders
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Suggested folders

  /folders/move-files:
    post:
      tags: [Folders]
      summary: Move files between folders
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                note_ids:
                  type: array
                  items:
                    type: integer
                target_folder_id:
                  type: integer
      responses:
        '200':
          description: Files moved

  /folders/{id}:
    get:
      tags: [Folders]
      summary: Get a specific folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Folder details
    patch:
      tags: [Folders]
      summary: Rename a folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Folder renamed
    delete:
      tags: [Folders]
      summary: Delete a folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: delete_contents
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Folder deleted

  /folders/{id}/move:
    post:
      tags: [Folders]
      summary: Move folder and its contents
      description: |
        Moves a folder to a new parent folder or to a different workspace.
        This operation is **recursive**: all subfolders and notes within the folder will be moved to the target workspace.
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                parent_id:
                  type: integer
                  nullable: true
                  description: ID of the new parent folder. Use `null` to move to the root level.
                target_workspace:
                  type: string
                  nullable: true
                  description: Name of the target workspace. If omitted, the folder remains in its current workspace.
      responses:
        '200':
          description: Folder and all its contents moved successfully
        '400':
          description: Invalid request (e.g., target parent is in a different workspace)
        '404':
          description: Folder or target workspace not found
        '409':
          description: Conflict (e.g., folder with same name exists or move would create a cycle)

  /folders/{id}/empty:
    post:
      tags: [Folders]
      summary: Empty folder (move notes to trash)
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Folder emptied

  /folders/{id}/icon:
    put:
      tags: [Folders]
      summary: Update folder icon
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                icon:
                  type: string
                  example: "fa-folder-open"
      responses:
        '200':
          description: Icon updated

  /folders/{id}/notes:
    get:
      tags: [Folders]
      summary: Get note count in folder
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Note count

  /folders/{id}/path:
    get:
      tags: [Folders]
      summary: Get folder path
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Folder path

  # ==================
  # Trash Endpoints
  # ==================
  /trash:
    get:
      tags: [Trash]
      summary: List notes in trash
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of trashed notes
    delete:
      tags: [Trash]
      summary: Empty trash (delete all)
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Trash emptied

  /trash/{id}:
    delete:
      tags: [Trash]
      summary: Permanently delete a note from trash
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Note permanently deleted

  # ==================
  # Workspaces Endpoints
  # ==================
  /workspaces:
    get:
      tags: [Workspaces]
      summary: List all workspaces
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: List of workspaces
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  workspaces:
                    type: array
                    items:
                      $ref: '#/components/schemas/Workspace'
    post:
      tags: [Workspaces]
      summary: Create a new workspace
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: "New Workspace"
      responses:
        '201':
          description: Workspace created

  /workspaces/{name}:
    patch:
      tags: [Workspaces]
      summary: Rename a workspace
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                new_name:
                  type: string
      responses:
        '200':
          description: Workspace renamed
    delete:
      tags: [Workspaces]
      summary: Delete a workspace
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Workspace deleted

  # ==================
  # Tags Endpoints
  # ==================
  /tags:
    get:
      tags: [Tags]
      summary: List all unique tags
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tags:
                    type: array
                    items:
                      type: string

  # ==================
  # Settings Endpoints
  # ==================
  /settings/{key}:
    get:
      tags: [Settings]
      summary: Get a setting value
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: key
          in: path
          required: true
          schema:
            type: string
            enum: [language, theme, editor_font_size, sidebar_width, last_workspace]
      responses:
        '200':
          description: Setting value
    put:
      tags: [Settings]
      summary: Set a setting value
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: key
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                value:
                  type: string
      responses:
        '200':
          description: Setting updated

  # ==================
  # Backup Endpoints
  # ==================
  /backups:
    get:
      tags: [Backups]
      summary: List all backups (requires admin credentials and X-User-ID)
      description: |
        Lists all backups for the specified user. Requires admin credentials.
        The X-User-ID header specifies which user's backups to list.
      parameters:
        - name: X-User-ID
          in: header
          required: true
          schema:
            type: integer
          description: ID of the user whose backups to list
          example: 9
      responses:
        '200':
          description: List of backups
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  backups:
                    type: array
                    items:
                      $ref: '#/components/schemas/Backup'
                  total:
                    type: integer
    post:
      tags: [Backups]
      summary: Create a new backup (requires admin credentials and X-User-ID)
      description: |
        Creates a backup for the specified user. Requires admin credentials.
        The X-User-ID header specifies which user's data to backup.
      parameters:
        - name: X-User-ID
          in: header
          required: true
          schema:
            type: integer
          description: ID of the user to backup
          example: 9
      responses:
        '201':
          description: Backup created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  filename:
                    type: string
                  size:
                    type: integer
                  download_url:
                    type: string

  /backups/{filename}:
    get:
      tags: [Backups]
      summary: Download a backup (requires admin credentials and X-User-ID)
      description: |
        Downloads a backup file. Requires admin credentials.
        The X-User-ID header specifies which user's backup to download.
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
          example: poznote_backup_2026-02-02_15-30-00.zip
        - name: X-User-ID
          in: header
          required: true
          schema:
            type: integer
          description: ID of the user who owns this backup
          example: 9
      responses:
        '200':
          description: Backup file download
          content:
            application/zip:
              schema:
                type: string
                format: binary
    delete:
      tags: [Backups]
      summary: Delete a backup (requires admin credentials and X-User-ID)
      description: |
        Deletes a backup file. Requires admin credentials.
        The X-User-ID header specifies which user's backup to delete.
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
          example: poznote_backup_2026-02-02_15-30-00.zip
        - name: X-User-ID
          in: header
          required: true
          schema:
            type: integer
          description: ID of the user who owns this backup
          example: 9
      responses:
        '200':
          description: Backup deleted

  /backups/{filename}/restore:
    post:
      tags: [Backups]
      summary: Restore a backup
      description: Restore a backup file. This will replace all current user data (database, notes, and attachments) with the data from the backup.
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
            example: poznote_backup_2026-02-02_15-30-00.zip
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: Backup restored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  details:
                    type: object
        '400':
          description: Invalid backup filename format
        '404':
          description: Backup file not found
        '500':
          description: Failed to restore backup

  # ==================
  # System Endpoints
  # ==================
  /system/version:
    get:
      tags: [System]
      summary: Get version information
      responses:
        '200':
          description: Version info
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  current_version:
                    type: string
                    example: "2.0.2"
                  latest_version:
                    type: string
                    example: "2.0.2"
                  is_up_to_date:
                    type: boolean

  /system/updates:
    get:
      tags: [System]
      summary: Check for updates
      responses:
        '200':
          description: Update check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  has_updates:
                    type: boolean
                  current_version:
                    type: string
                  remote_version:
                    type: string

  /system/i18n:
    get:
      tags: [System]
      summary: Get translations
      responses:
        '200':
          description: Translation strings
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  lang:
                    type: string
                    example: "en"
                  strings:
                    type: object
                    additionalProperties:
                      type: string

  /system/verify-password:
    post:
      tags: [System]
      summary: Verify settings password
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                password:
                  type: string
      responses:
        '200':
          description: Password verified
        '401':
          description: Invalid password

  # ==================
  # Export Endpoints (Legacy - File Downloads)
  # ==================
  /api_export_note.php:
    get:
      tags: [Export]
      summary: Export a note
      description: Download a note in various formats (HTML, Markdown, PDF, DOCX)
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: query
          required: true
          schema:
            type: integer
        - name: format
          in: query
          schema:
            type: string
            enum: [html, markdown, md, pdf, docx]
            default: html
      responses:
        '200':
          description: File download

  /api_export_folder.php:
    get:
      tags: [Export]
      summary: Export a folder as ZIP
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: folder_id
          in: query
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: ZIP file download

  /api_export_entries.php:
    get:
      tags: [Export]
      summary: Export all entries as ZIP
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: ZIP file download

  /api_export_structured.php:
    get:
      tags: [Export]
      summary: Export structured data
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: workspace
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Structured export download

  /api_export_attachments.php:
    get:
      tags: [Export]
      summary: Export all attachments as ZIP
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: ZIP file download

  /api_download_note.php:
    get:
      tags: [Export]
      summary: Download note file
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
        - name: id
          in: query
          required: true
          schema:
            type: integer
        - name: type
          in: query
          schema:
            type: string
            enum: [note, markdown, tasklist, excalidraw]
      responses:
        '200':
          description: File download

  /api_save_excalidraw.php:
    post:
      tags: [Export]
      summary: Save Excalidraw diagram
      description: Save or update an Excalidraw drawing
      parameters:
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                note_id:
                  type: integer
                workspace:
                  type: string
                heading:
                  type: string
                diagram_data:
                  type: string
                preview_image:
                  type: string
                  format: binary
      responses:
        '200':
          description: Diagram saved

  # ==================
  # User Management Endpoints
  # ==================
  /users/profiles:
    get:
      tags: [Users]
      summary: Get available user profiles (public)
      description: |
        Returns a list of active user profiles for login/selection purposes.
        This endpoint does NOT require authentication and is used by the login page.
        Does NOT require X-User-ID header.
      security: []
      responses:
        '200':
          description: List of active user profiles
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 1
                    username:
                      type: string
                      example: "admin"

  /users/lookup/{username}:
    get:
      tags: [Users]
      summary: Get user ID by username (admin only)
      description: |
        Converts a username to a user ID. Accessible to administrators only.
        Does NOT require X-User-ID header (since the purpose is to find the ID).
        Used by backup scripts to resolve usernames to IDs.
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
          description: Username to lookup
          example: "Nina"
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 9
                  username:
                    type: string
                    example: "Nina"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "User not found"

  /admin/users:
    get:
      tags: [Users]
      summary: List all user profiles (admin only)
      description: |
        Get detailed list of all user profiles with storage statistics.
        Requires admin privileges. Does NOT require X-User-ID header.
      responses:
        '200':
          description: List of users with statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        username:
                          type: string
                        is_admin:
                          type: boolean
                        active:
                          type: boolean
                        created_at:
                          type: string
                          format: date-time
                        last_login:
                          type: string
                          format: date-time
                          nullable: true
                        storage_bytes:
                          type: integer
                        notes_count:
                          type: integer
                        attachments_count:
                          type: integer
                  total:
                    type: integer
        '403':
          description: Admin access required
    post:
      tags: [Users]
      summary: Create a new user profile (admin only)
      description: |
        Create a new user profile. Requires admin privileges.
        Does NOT require X-User-ID header.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  type: string
                  example: "newuser"
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string
        '400':
          description: Invalid request or username already exists
        '403':
          description: Admin access required

  /admin/users/{id}:
    get:
      tags: [Users]
      summary: Get a specific user profile (admin only)
      description: |
        Get detailed information about a specific user including storage statistics.
        Requires admin privileges. Does NOT require X-User-ID header.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User profile details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  username:
                    type: string
                  is_admin:
                    type: boolean
                  active:
                    type: boolean
                  created_at:
                    type: string
                    format: date-time
                  last_login:
                    type: string
                    format: date-time
                    nullable: true
                  storage:
                    type: object
                    properties:
                      total:
                        type: integer
                      database:
                        type: integer
                      entries:
                        type: integer
                      attachments:
                        type: integer
                  notes_count:
                    type: integer
                  attachments_count:
                    type: integer
        '404':
          description: User not found
        '403':
          description: Admin access required
    patch:
      tags: [Users]
      summary: Update a user profile (admin only)
      description: |
        Update user profile properties (username, active status, admin status).
        Requires admin privileges. Does NOT require X-User-ID header.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: "newusername"
                active:
                  type: boolean
                is_admin:
                  type: boolean
      responses:
        '200':
          description: User updated successfully
        '400':
          description: Invalid request
        '403':
          description: Admin access required
        '404':
          description: User not found
    delete:
      tags: [Users]
      summary: Delete a user profile (admin only)
      description: |
        Delete a user profile. Optionally delete all user data.
        Cannot delete your own profile or the last admin.
        Requires admin privileges. Does NOT require X-User-ID header.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: delete_data
          in: query
          schema:
            type: boolean
            default: false
          description: If true, also delete all user data (notes, attachments, etc.)
      responses:
        '200':
          description: User deleted successfully
        '400':
          description: Cannot delete own profile or last admin
        '403':
          description: Admin access required
        '404':
          description: User not found

  /admin/stats:
    get:
      tags: [Users]
      summary: Get system statistics (admin only)
      description: |
        Get aggregated statistics for all users (total storage, notes count, etc.).
        Requires admin privileges. Does NOT require X-User-ID header.
      responses:
        '200':
          description: System statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_users:
                    type: integer
                  active_users:
                    type: integer
                  admin_users:
                    type: integer
                  total_storage_bytes:
                    type: integer
                  total_storage_mb:
                    type: number
                  total_notes:
                    type: integer
                  total_attachments:
                    type: integer
        '403':
          description: Admin access required

  /admin/repair:
    post:
      tags: [Users]
      summary: Repair master database (admin only)
      description: |
        Scan user data directories and rebuild the master database registry.
        This includes rebuilding shared links and discovering orphaned users.
        Requires admin privileges. Does NOT require X-User-ID header.
      responses:
        '200':
          description: Repair completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  stats:
                    type: object
                    properties:
                      users_scanned:
                        type: integer
                      users_added:
                        type: integer
                      links_rebuilt:
                        type: integer
                      errors:
                        type: array
                        items:
                          type: string
        '403':
          description: Admin access required
